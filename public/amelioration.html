// === public/amelioration.html ===
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Am√©liore ton image</title>
  <style>
    body { font-family: sans-serif; padding: 40px; text-align: center; }
    h1 { font-size: 2rem; margin-bottom: 20px; }
    #pixelbin-actions { margin-bottom: 24px; }
    #uploadBtn {
      background: #007bff; color: #fff; border: none; padding: 8px 16px;
      border-radius: 4px; cursor: pointer; margin-left: 8px;
    }
    #uploadBtn:disabled { opacity: 0.6; cursor: not-allowed; }
    #downloadBtn {
      background: #28a745; color: #fff; border: none; padding: 8px 16px;
      border-radius: 4px; cursor: pointer; margin-left: 8px; display: none;
    }
    #pixelbin-result {
      display: flex; justify-content: space-between; flex-wrap: wrap;
      gap: 20px; margin-top: 20px;
    }
    .image-block { flex: 0 1 45%; text-align: center; }
    .image-block img { max-width: 100%; border-radius: 8px; }
    .spinner {
      border: 4px solid rgba(0,0,0,0.1); width: 24px; height: 24px;
      border-radius: 50%; border-left-color: #000;
      animation: spin 1s linear infinite; display: inline-block;
      vertical-align: middle; margin-right: 8px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <h1>Am√©liore ton image üîç</h1>
  <div id="pixelbin-actions">
    <input type="file" id="pixelbin-upload-input" accept="image/*">
    <button id="uploadBtn">Am√©liorer l‚Äôimage</button>
    <button id="downloadBtn">üíæ T√©l√©charger</button>
  </div>
  <div id="pixelbin-result"></div>

  <script>
  (function(){
    const UPLOAD_URL  = "/upload";
    const input       = document.getElementById("pixelbin-upload-input");
    const uploadBtn   = document.getElementById("uploadBtn");
    const downloadBtn = document.getElementById("downloadBtn");
    const result      = document.getElementById("pixelbin-result");
    let blobUrl;

    uploadBtn.addEventListener("click", async () => {
      if (!input.files.length) return alert("S√©lectionnez une image.");
      const file = input.files[0];

      const reader = new FileReader();
      reader.onload = () => {
        result.innerHTML = `
          <div class="image-block">
            <p>üåç Avant</p>
            <img src="${reader.result}" alt="Avant">
          </div>`;
      };
      reader.readAsDataURL(file);

      uploadBtn.disabled = true;
      uploadBtn.textContent = "";
      const spinner = document.createElement("div");
      spinner.className = "spinner";
      uploadBtn.appendChild(spinner);
      downloadBtn.style.display = "none";

      try {
        const form = new FormData();
        form.append("image", file);
        const resp = await fetch(UPLOAD_URL, { method: "POST", body: form });
        const { transformedUrl } = await resp.json();

        result.innerHTML += `
          <div class="image-block">
            <p>‚ú® Apr√®s</p>
            <img src="${transformedUrl}" alt="Apr√®s">
          </div>`;

        const r2 = await fetch(transformedUrl);
        const blob = await r2.blob();
        blobUrl = URL.createObjectURL(blob);
        downloadBtn.style.display = "inline-block";
      } catch (e) {
        alert("Erreur : " + e.message);
      } finally {
        uploadBtn.disabled = false;
        uploadBtn.textContent = "Am√©liorer l‚Äôimage";
      }
    });

    downloadBtn.addEventListener("click", () => {
      if (!blobUrl) return;
      const file = input.files[0];
      const ext = file.type.split("/")[1] || "png";
      const name = file.name.replace(/\.\w+$/, "") + "_HD." + ext;
      const a = document.createElement("a");
      a.href = blobUrl;
      a.download = name;
      document.body.appendChild(a);
      a.click();
      a.remove();
    });
  })();
  </script>
</body>
</html>
