<script>
(function(){
  const UPLOAD_URL  = "https://pixelbin-shopify-uploader.onrender.com/upload";
  const input       = document.getElementById("pixelbin-upload-input");
  const uploadBtn   = document.getElementById("uploadBtn");
  const downloadBtn = document.getElementById("downloadBtn");
  const result      = document.getElementById("pixelbin-result");
  let blobUrl; 

  uploadBtn.addEventListener("click", async () => {
    if (!input.files.length) return alert("S√©lectionnez une image.");
    const file = input.files[0];

    // Aper√ßu "Avant"
    const reader = new FileReader();
    reader.onload = () => {
      result.innerHTML = `
        <div class="image-block">
          <p>üåç Avant :</p>
          <img src="${reader.result}" alt="Avant">
        </div>`;
    };
    reader.readAsDataURL(file);

    // Spinner et d√©sactivation
    uploadBtn.disabled   = true;
    uploadBtn.textContent = "";
    const spinner = document.createElement("div");
    spinner.className = "spinner";
    uploadBtn.appendChild(spinner);
    downloadBtn.style.display = "none";

    try {
      // Envoi
      const form = new FormData();
      form.append("image", file);
      const resp = await fetch(UPLOAD_URL, { method:"POST", body: form });
      const { originalUrl, transformedUrl } = await resp.json();

      // Aper√ßu "Apr√®s"
      result.innerHTML += `
        <div class="image-block">
          <p>‚ú® Apr√®s :</p>
          <img src="${transformedUrl}" alt="Apr√®s">
        </div>`;

      // Cr√©er Blob pour t√©l√©chargement (corrig√©)
      const response = await fetch(encodeURI(transformedUrl));
      const blob = await response.blob();
      const contentType = response.headers.get("Content-Type") || "image/png";
      blobUrl = URL.createObjectURL(new Blob([blob], { type: contentType }));

      // Afficher bouton
      downloadBtn.style.display = "inline-block";
    } catch (e) {
      alert("Erreur : " + e.message);
    } finally {
      uploadBtn.disabled   = false;
      uploadBtn.textContent = "Am√©liorer l‚Äôimage";
    }
  });

  downloadBtn.addEventListener("click", () => {
    if (!blobUrl) return;
    const file = input.files[0];
    const ext  = file.type.split("/")[1] || "png";
    const baseName = file.name.replace(/\.\w+$/, "");
    const suffix = Math.random().toString(36).substring(2, 8);
    const name = `${baseName}_${suffix}.${ext}`;

    const a = document.createElement("a");
    a.href = blobUrl;
    a.download = name;
    document.body.appendChild(a);
    a.click();
    a.remove();
  });
})();
</script>
